<html>
    <head>
        <meta charset="UTF-8">
        <title>^_^</title>
        <style>
            .qw{
                background-color:white;
                visibility:hidden;
            }
            input,button{
                width:18vw;
                font-size:2vw;
            }
            canvas{
                width: 30vw;
                height: auto;
            }
        </style>
    </head>
    <body style="background-color:rgb(154 98 127);color:white;">
        <input type="file" name="fla"  id="eda" accept="image/*" onchange="lfa(event)">
        <input type="file" name="flb"  id="edb" accept="image/*" onchange="lfb(event)">
        <button onclick="qa()">Merge!</button>
        <button onclick="qb()">Change!</button>
        <button onclick="dl()">Download!</button>
        <br>
        <input type="range" min="0" max="100" value="100" id="ipta">
        <span id="spna"> </span>
        <input type="range" min="0" max="100" value="30" id="iptb">
        <span id="spnb"> </span>
        <span id="spnc"> </span>
        <br>
        <canvas id="a1" class="qw"></canvas>
        <canvas id="b1" class="qw"></canvas>
        <canvas id="c1" class="qw"></canvas>
        <script>
            var a1 = document.getElementById("a1");
            var ctxa = a1.getContext('2d');
            var b1 = document.getElementById("b1");
            var ctxb = b1.getContext('2d');
            var b1 = document.getElementById("b1");
            var c1 = document.getElementById("c1");
            var ctxc = c1.getContext('2d');
            var qw = document.querySelectorAll('.qw');
            var ipta = document.getElementById("ipta");
            var iptb = document.getElementById("iptb");
            var spna = document.getElementById("spna");
            var spnb = document.getElementById("spnb");
            var spnc = document.getElementById("spnc");
            var qe=1;
            var ax=-1,ay=-1,bx=-1,by=-1;
            spna.innerText=ipta.value;
            spnb.innerText=iptb.value;
            ipta.oninput=()=>{
                spna.innerText=ipta.value;
            }
            iptb.oninput=()=>{
                spnb.innerText=iptb.value;
            }
            function qa(){
                if(ax<0||bx<0)return;
                spnc.innerText="Processing...";
                setTimeout(()=>{
                    var width = Math.max(ax, bx);
                    var height = Math.max(ay, by);
                    
                    function scaleImage(srcCanvas, srcW, srcH, targetW, targetH,c) {
                        var result = document.createElement('canvas');
                        result.width = targetW;
                        result.height = targetH;
                        var ctx = result.getContext('2d');
                        ctx.fillStyle = c?"black":"white";
                        ctx.fillRect(0, 0, targetW, targetH);
                        
                        var srcRatio = srcW / srcH;
                        var targetRatio = targetW / targetH;
                        var drawW, drawH, offsetX = 0, offsetY = 0;
                        
                        if(srcRatio > targetRatio) {
                            drawW = targetW;
                            drawH = targetW / srcRatio;
                            offsetY = (targetH - drawH) / 2;
                        } else {
                            drawH = targetH;
                            drawW = targetH * srcRatio;
                            offsetX = (targetW - drawW) / 2;
                        }
                        
                        ctx.drawImage(srcCanvas, 0, 0, srcW, srcH, offsetX, offsetY, drawW, drawH);
                        return result;
                    }
                    
                    var resizedA = scaleImage(a1, ax, ay, width, height,0);
                    var resizedB = scaleImage(b1, bx, by, width, height,1);
                    
                    var ctxResizedA = resizedA.getContext('2d');
                    var ctxResizedB = resizedB.getContext('2d');
                    var ca = ctxResizedA.getImageData(0,0,width,height).data;
                    var cb = ctxResizedB.getImageData(0,0,width,height).data;
                    var buffer = new Uint8ClampedArray(width * height * 4);
                    
                    for(var y = 0; y < height; y++) {
                        for(var x = 0; x < width; x++) {
                            var pos = (y * width + x) * 4;
                            var grayA = (ca[pos]+ca[pos+1]+ca[pos+2])/3;
                            var grayB = (cb[pos]+cb[pos+1]+cb[pos+2])/3;
                            
                            grayA = parseInt(grayA *parseInt(ipta.value)/100);
                            grayB = parseInt(grayB *parseInt(iptb.value)/100);
                            let g=grayB/(1-Math.abs(grayA-grayB)/255);
                            buffer[pos  ] = g;
                            buffer[pos+1] = g;
                            buffer[pos+2] = g;
                            buffer[pos+3] = Math.max(0, Math.min(255, 255-Math.abs(grayA - grayB)));
                        }
                    }
                    
                    c1.width = width;
                    c1.height = height;
                    c1.style.visibility="visible";
                    var idata = ctxc.createImageData(width, height);
                    idata.data.set(buffer);
                    ctxc.putImageData(idata, 0, 0);
                    spnc.innerText="Done!";
                },0);
            }
            function qb(){
                if(qe){
                    for(let i=0;i<qw.length;i++){
                        qw[i].style.backgroundColor="black";
                    }
                }
                else{
                    for(let i=0;i<qw.length;i++){
                        qw[i].style.backgroundColor="white";
                    }
                }
                qe^=1;
            }
            function dl(){
                var link = document.createElement('a');
                link.download = 'image.png';
                link.href = c1.toDataURL();
                link.click();
            }
            var lfa = function(e) {
                let file = e.target.files[0];
                if (file) {
                    var img = new Image;
                    img.src = URL.createObjectURL(e.target.files[0]);
                    img.onload = ()=>{
                        a1.width=img.width;
                        a1.height=img.height;
                        ax = a1.width;
                        ay = a1.height;
                        a1.style.visibility="visible";
                        ctxa.drawImage(img, 0,0);
                    }
                }
            }
            var lfb = function(e) {
                let file = e.target.files[0];
                if (file) {
                    var img = new Image;
                    img.src = URL.createObjectURL(e.target.files[0]);
                    img.onload = ()=>{
                        b1.width=img.width;
                        b1.height=img.height;
                        bx = b1.width;
                        by = b1.height;
                        b1.style.visibility="visible";
                        ctxb.drawImage(img, 0,0);
                    }
                }
            }
            document.body.onkeydown=(k)=>{
                if(k.key=='a'){
                    qa();
                }
                if(k.key=='b'){
                    qb();
                }
            }
        </script>
    </body>
</html>